<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ソルトクエスト1</title>
    <style>
        @font-face {
            font-family: 'cinecaption';
            src: url('../fonts/cinecaption226.ttf') format('truetype');
        }
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'cinecaption','Arial', sans-serif;
            background-color: #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
        canvas {
            display: block;
            border: 2px solid #555;
            margin: 10px 0; /* 上下に余白を追加 */
        }
        #game-info {
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 5px;
            text-align: center;
            margin: 10px;
            height: 15%;
            width: 350px;
        }
        #main-page-link {
            padding: 10px;
            background-color: #3498db;
            color: #fff;
            text-decoration: none;
            border-radius: 5px;
            margin-top: 10px; /* 上に余白を追加 */
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <div id="game-info">
        <div id="point">x: 0, y: 0</div>
        <div id="message">SaltQuestⅠ</div>
    </div>
    <a href="../index.html" id="main-page-link">Return to main page</a>
    <script src="mapdata.js"></script>
    <script>
        // マップデータ（数字はタイルの種類）

        // 画像のURL
        var tilesetURL = 'https://www.spriters-resource.com/resources/sheets/10/10199.png';
        var mapURL = 'https://www.spriters-resource.com/resources/sheets/106/109509.png';
        var characterURL = 'https://www.spriters-resource.com/resources/sheets/39/41381.png';

        // タイルのサイズ
        var tileSize = 16;
        var rate = 1.5;

        // マップサイズ
        var mapWidth = mapData[0].length;
        var mapHeight = mapData.length;

        // スクリーンサイズ
        var screenWidth = 16;
        var screenHeight = 16;

        // フラグとクリア条件を管理するオブジェクト
        // var flags = {
        //     delivery: { flag: false, location: { x: 9, y: 9 } },
        //     castle: { flag: false, location: { x: 51, y: 51 } }
        //     // 他にも必要なフラグやクリア条件を追加する
        // };

        var flags = {
            fairyFlute: { flag: false, location: { x: 112, y: 18 } },
            magicKey: { flag: false, location: { x: 110, y: 80 } },
            roraRescued: { flag: false, location: { x: 0, y: 0 } },
            roraLove: { flag: false, location: { x: 0, y: 0 } },
            sunStone: { flag: false, location: { x: 0, y: 0 } },
            silverHerp: { flag: false, location: { x: 0, y: 0 } },
            rainCloudStuff: { flag: false, location: { x: 0, y: 0 } },
            rotoArmor: { flag: false, location: { x: 0, y: 0 } },
            golemKilled: { flag: false, location: { x: 0, y: 0 } },
            rotoEmblem: { flag: false, location: { x: 0, y: 0 } },
            rainbowDrop: { flag: false, location: { x: 0, y: 0 } },
            rainbowBridge: { flag: false, location: { x: 0, y: 0 } },
            lightBall: { flag: false, location: { x: 0, y: 0 } }
        };

        // プレイヤーの初期位置
        var playerPosition = { x: 51, y: 51 };

        // Canvasの設定
        var canvas = document.getElementById('canvas');
        var ctx = canvas.getContext('2d');
        canvas.width = screenWidth * tileSize * rate;
        canvas.height = screenHeight * tileSize * rate;

        var message = '';

        // イメージのロード
        var characterImage = new Image();
        characterImage.src = characterURL;
        var tilesetImage = new Image();
        tilesetImage.src = tilesetURL;
        tilesetImage.onload = function () {
            drawScreen();
        };

        function drawTile(x, y, index){
            var offsetX = 3;
            var offsetY = 2;
            var offsetTile = 1;
            var tileRowLength = 25;
            var src = tilesetImage;
            ctx.drawImage(src, offsetX+(index % tileRowLength) * (tileSize+offsetTile), offsetY+Math.floor(index / tileRowLength) * (tileSize+offsetTile), tileSize, tileSize, x * tileSize*rate, y * tileSize*rate, tileSize*rate, tileSize*rate);
        }
        function drawCharacter(x, y, index){
            var offsetX = 8;
            var offsetY = 8;
            var offsetTile = 8;
            var tileRowLength = 14;
            var src = characterImage;
            ctx.drawImage(src, offsetX+(index % tileRowLength) * (tileSize+offsetTile), offsetY+Math.floor(index / tileRowLength) * (tileSize+offsetTile), tileSize, tileSize, x * tileSize*rate, y * tileSize*rate, tileSize*rate, tileSize*rate);
        }

        function isVisitMaira(position){
            return position.x === flags.fairyFlute.location.x && position.y === flags.fairyFlute.location.y;
        }
        function isVisitCaveNorth(position){
            return position.x === 112 && position.y === 52;
        }
        function isVisitCaveSouth(position){
            return position.x === 112 && position.y === 57;
        }
        function isVisitCave(position){
            return isVisitCaveNorth(position) || isVisitCaveSouth(position);
        }
        function isVisitRimurudaru(position){
            return position.x === flags.magicKey.location.x && position.y === flags.magicKey.location.y;
        }

        function isVisitCastle(position){
            return position.x === 51 && position.y === 51;
        }

        function checkConditions() {
            message = '';
            if(isVisitMaira(playerPosition)){
                if(!flags.fairyFlute.flag){
                    flags.fairyFlute.flag = true;
                    message += '妖精の笛を手に入れた！';
                }else{
                    message += 'ここはマイラの村だ';
                }
            }
            if(isVisitCave(playerPosition)){
                if(!flags.roraRescued.flag){
                    if(!flags.magicKey.flag){
                        message += '洞窟の中に扉があったが、鍵が無いので開けられなかった...';
                    }else{
                        flags.roraRescued.flag = true;
                        message += '魔法の鍵で扉を開けた！\n';
                        message += 'ドラゴンを倒してローラ姫を救出した！';
                    }
                }else{
                    message += '倒したドラゴンのことは今度片付けよう';
                }
                if(isVisitCaveNorth(playerPosition)){
                    playerPosition.y = 57;
                }else if(isVisitCaveSouth(playerPosition)){
                    playerPosition.y = 52;
                }
            }
            if(isVisitRimurudaru(playerPosition)){
                if(!flags.magicKey.flag){
                    flags.magicKey.flag = true;
                    message += '魔法の鍵を手に入れた！';
                }else{
                    message += 'ここはリムルダールの町だ';
                }
            }
            if(isVisitCastle(playerPosition)){
                if(!flags.roraRescued.flag){
                    message += 'ここはラダトームの城だ\n';
                    message += '王「ローラ姫はどこへ...」';
                }else{
                    message += '王「ローラ姫！」\n';
                    message += '王「勇者よ！よくぞローラ姫を救い出してくれた！」\n';
                    message += 'GAME CLEAR!';
                }
            }
            document.getElementById('message').innerText = message;
        }

        function screenXToWorldX(screenX){
            return ((playerPosition.x - screenWidth/2 + screenX) + mapWidth) % mapWidth;
        }

        function screenYToWorldY(screenY){
            return ((playerPosition.y - screenHeight/2 + screenY) + mapHeight) % mapHeight;
        }

        var index = 4;
        function drawScreen() {
            // 条件の確認
            checkConditions();

            for (var y = 0; y <= screenHeight; y++) {
                for (var x = 0; x <= screenWidth; x++) {
                    var tileIndex = mapData[screenYToWorldY(y)][screenXToWorldX(x)];
                    if(tileIndex >= 350) tileIndex -= 12*25;
                    if(x === screenWidth/2 && y === screenHeight/2){
                        drawCharacter(x, y, index);
                        index++;
                        index = (index + 2) % 2 + 4;
                    }else{
                        drawTile(x, y, tileIndex);
                    }
                }
            }

            document.getElementById('point').innerText = `x: ${playerPosition.x}, y: ${playerPosition.y}`;
        }

        window.addEventListener('keydown', function (e) {
            switch (e.key) {
                case 'ArrowUp':
                    playerPosition.y--;
                    playerPosition.y = (playerPosition.y + mapHeight) % mapHeight;
                    break;
                case 'ArrowDown':
                    playerPosition.y++;
                    playerPosition.y = (playerPosition.y + mapHeight) % mapHeight;
                    break;
                case 'ArrowLeft':
                    playerPosition.x--;
                    playerPosition.x = (playerPosition.x + mapWidth) % mapWidth;
                    break;
                case 'ArrowRight':
                    playerPosition.x++;
                    playerPosition.x = (playerPosition.x + mapWidth) % mapWidth;
                    break;
                default:
                    break;
            }
            drawScreen();
        });

        // タッチデバイスの場合にはデフォルトのスクロールを防ぐ
        if ('ontouchstart' in window) {
            document.body.style.touchAction = 'none';
        }

        window.addEventListener('touchstart', function (e) {
            // タッチ位置を取得
            var touchX = e.touches[0].clientX;
            var touchY = e.touches[0].clientY;

            // 画面の中央を起点にしてタッチ位置を計算
            var centerX = window.innerWidth / 2;
            var centerY = window.innerHeight / 2;

            // タッチ位置と中央位置の差を計算
            var deltaX = touchX - centerX;
            var deltaY = touchY - centerY;

            // 差の絶対値が大きい方に動く方向を設定
            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                // 左右移動
                playerPosition.x += deltaX > 0 ? 1 : -1;
                playerPosition.x = (playerPosition.x + mapWidth) % mapWidth;
            } else {
                // 上下移動
                playerPosition.y += deltaY > 0 ? 1 : -1;
                playerPosition.y = (playerPosition.y + mapHeight) % mapHeight;
            }

            drawScreen();

            // デフォルトのスクロールを防ぐ
            e.preventDefault();
        });

        window.onload = function () {
            drawScreen();
        };
    </script>
</body>
</html>
